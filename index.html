<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rowan Middle School Rankings</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 30px 0 30px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header h1 {
            font-size: 2.5em;
            flex: 1;
        }

        .controls-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .controls-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }

        .tabs-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 0 30px;
            display: flex;
            gap: 5px;
        }

        .tab {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 15px 30px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
            position: relative;
            top: 2px;
        }

        .tab:hover {
            background: rgba(255,255,255,0.3);
        }

        .tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
        }

        .user-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .user-indicator.mom {
            background: #e91e63;
        }

        .user-indicator.dad {
            background: #2196f3;
        }

        .user-indicator.rowan {
            background: #4caf50;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h2 {
            color: #667eea;
            font-size: 24px;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #adb5bd;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f8f9fa;
            color: #495057;
        }

        .weight-slider-container {
            margin-bottom: 25px;
        }

        .weight-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
            color: #495057;
        }

        .weight-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .weight-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .weight-name label {
            cursor: pointer;
            user-select: none;
        }

        .weight-value {
            font-weight: 700;
            color: #667eea;
            font-size: 16px;
            min-width: 60px;
            text-align: right;
        }

        .weight-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e9ecef;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .weight-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            transition: all 0.2s;
        }

        .weight-slider::-webkit-slider-thumb:hover {
            background: #5568d3;
            transform: scale(1.1);
        }

        .weight-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .weight-slider::-moz-range-thumb:hover {
            background: #5568d3;
            transform: scale(1.1);
        }

        .weight-total {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
        }

        .weight-total-value {
            font-size: 24px;
            font-weight: 700;
            margin-left: 10px;
        }

        .weight-total-value.valid {
            color: #28a745;
        }

        .weight-total-value.invalid {
            color: #dc3545;
        }

        .weight-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .weight-btn {
            flex: 1;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .weight-btn-reset {
            background: #6c757d;
            color: white;
        }

        .weight-btn-reset:hover {
            background: #5a6268;
        }

        .weight-btn-save {
            background: #667eea;
            color: white;
        }

        .weight-btn-save:hover {
            background: #5568d3;
        }

        .weight-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .ranking-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .ranking-item {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        .ranking-number {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
            min-width: 30px;
        }

        .ranking-details {
            flex: 1;
        }

        .ranking-school-name {
            font-weight: 600;
            color: #212529;
            margin-bottom: 5px;
        }

        .ranking-stats {
            font-size: 14px;
            color: #6c757d;
        }

        .ranking-avg {
            font-weight: 700;
            color: #28a745;
        }

        .ranking-individual {
            margin-left: 8px;
            color: #adb5bd;
        }

        .avg-rank-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .avg-rank-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }

        .column-controls {
            background: #f8f9fa;
            padding: 20px 30px;
            border-bottom: 2px solid #e9ecef;
            display: none;
        }

        .column-controls.active {
            display: block;
        }

        .column-controls h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .column-toggles {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .toggle-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .toggle-item label {
            cursor: pointer;
            color: #495057;
            font-size: 14px;
        }

        .table-container {
            overflow-x: auto;
            padding: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 30px;
        }

        th.sortable:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sort-arrows {
            display: inline-flex;
            flex-direction: column;
            margin-left: 5px;
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
        }

        .sort-arrow {
            font-size: 10px;
            line-height: 1;
            color: rgba(255, 255, 255, 0.4);
            transition: color 0.2s;
        }

        .sort-arrow.active {
            color: white;
            font-weight: bold;
        }

        .sort-arrow.up {
            margin-bottom: 2px;
        }

        th.hidden-col {
            display: none;
        }

        tbody tr {
            border-bottom: 1px solid #dee2e6;
            transition: background-color 0.2s;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        td {
            padding: 12px 10px;
            vertical-align: middle;
        }

        td.hidden-col {
            display: none;
        }

        .rank-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rank-display {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            min-width: 40px;
            text-align: center;
        }

        .drag-handle {
            cursor: grab;
            font-size: 20px;
            color: #adb5bd;
            user-select: none;
            padding: 5px;
            transition: color 0.2s;
        }

        .drag-handle:hover {
            color: #667eea;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        tbody tr {
            border-bottom: 1px solid #dee2e6;
            transition: background-color 0.2s;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        tbody tr.dragging {
            opacity: 0.5;
            background-color: #e9ecef;
        }

        tbody tr.drag-over {
            border-top: 3px solid #667eea;
        }

        tbody tr.drag-over-bottom {
            border-bottom: 3px solid #667eea;
        }

        .school-name {
            font-weight: 600;
            color: #212529;
            min-width: 200px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-staff {
            background: #667eea;
            color: white;
        }

        .badge-noteworthy {
            background: #ffc107;
            color: #000;
        }

        .info-text {
            font-size: 13px;
            line-height: 1.5;
            max-width: 300px;
        }

        .editable-cell {
            min-width: 150px;
            padding: 8px;
            border: 1px solid transparent;
            border-radius: 4px;
            transition: all 0.2s;
            cursor: text;
            background: #f8f9fa;
        }

        .editable-cell:hover {
            border-color: #dee2e6;
            background: #fff;
        }

        .editable-cell:focus {
            outline: none;
            border-color: #667eea;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .editable-cell.wide {
            min-width: 250px;
        }

        .editable-cell.narrow {
            min-width: 100px;
        }

        .percentage-cell {
            font-weight: 600;
            color: #495057;
        }

        td[style*="backgroundColor"] {
            transition: background-color 0.3s ease;
        }

        th[data-percentage="true"] {
            text-align: center;
        }

        .footer {
            background: #f8f9fa;
            padding: 20px 30px;
            text-align: center;
            color: #6c757d;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                padding: 20px 20px 0 20px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .header > div {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                justify-content: center;
            }

            .avg-rank-btn, .controls-btn {
                font-size: 13px;
                padding: 8px 15px;
            }

            .tabs-container {
                padding: 0 20px;
                justify-content: center;
            }

            .tab {
                padding: 12px 20px;
                font-size: 14px;
            }

            .table-container {
                padding: 15px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px 5px;
            }

            .column-toggles {
                grid-template-columns: 1fr;
            }

            .rank-display {
                font-size: 20px;
                min-width: 30px;
            }

            .drag-handle {
                font-size: 16px;
            }

            .modal-content {
                margin: 20px;
                max-width: calc(100% - 40px);
                max-height: calc(100vh - 40px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div></div>
            <h1>🎓 Middle School Rankings</h1>
            <div>
                <button class="avg-rank-btn" onclick="showAverageRankings()">📊 Average Rankings</button>
                <button class="avg-rank-btn" onclick="showWeightsModal()">⚖️ Adjust Weights</button>
                <button class="controls-btn" onclick="toggleControls()">☰ Show/Hide Columns</button>
            </div>
        </div>

        <div class="tabs-container">
            <button class="tab active" onclick="switchUser('mom')" id="tab-mom">
                <span class="user-indicator mom"></span>Mom
            </button>
            <button class="tab" onclick="switchUser('dad')" id="tab-dad">
                <span class="user-indicator dad"></span>Dad
            </button>
            <button class="tab" onclick="switchUser('rowan')" id="tab-rowan">
                <span class="user-indicator rowan"></span>Rowan
            </button>
        </div>

        <div class="column-controls" id="columnControls">
            <h3>Visible Columns</h3>
            <div class="column-toggles" id="columnToggles">
                <!-- Generated dynamically -->
            </div>
        </div>

        <div class="table-container">
            <table id="schoolTable">
                <thead>
                    <tr id="tableHeader">
                        <!-- Generated dynamically -->
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Generated dynamically -->
                </tbody>
            </table>
        </div>

        <div class="footer">
            Switch between Mom, Dad, and Rowan tabs to see each person's rankings. Drag and drop rows to reorder schools.
            <br>
            Special Sauce, Red Flags, Start Time, and Student:Teacher columns are editable. All changes are saved automatically.
        </div>
    </div>

    <div class="modal-overlay" id="avgRankModal" onclick="closeModalOnOverlay(event)">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🏆 Average Rankings</h2>
                <button class="modal-close" onclick="closeAverageRankings()">×</button>
            </div>
            <ul class="ranking-list" id="avgRankingList">
                <!-- Generated dynamically -->
            </ul>
        </div>
    </div>

    <div class="modal-overlay" id="weightsModal" onclick="closeModalOnOverlay(event)">
        <div class="modal-content">
            <div class="modal-header">
                <h2>⚖️ Adjust Category Weights</h2>
                <button class="modal-close" onclick="closeWeightsModal()">×</button>
            </div>
            <p style="color: #6c757d; margin-bottom: 20px; font-size: 14px;">
                Adjust the importance of each category in the cumulative score. Check multiple items to link them - when you adjust one, the others will automatically adjust to maintain 100%.
            </p>

            <div class="weight-slider-container">
                <div class="weight-label">
                    <span class="weight-name">
                        <input type="checkbox" class="weight-checkbox" id="check-principal" checked>
                        <label for="check-principal">Principal Effectiveness</label>
                    </span>
                    <span class="weight-value" id="weight-principal-value">16.67%</span>
                </div>
                <input type="range" min="0" max="100" step="0.1" value="16.666666666666668" class="weight-slider" id="weight-principal" oninput="updateWeightValue('principal')">
            </div>

            <div class="weight-slider-container">
                <div class="weight-label">
                    <span class="weight-name">
                        <input type="checkbox" class="weight-checkbox" id="check-teacher" checked>
                        <label for="check-teacher">Teacher Recommendations</label>
                    </span>
                    <span class="weight-value" id="weight-teacher-value">16.67%</span>
                </div>
                <input type="range" min="0" max="100" step="0.1" value="16.666666666666668" class="weight-slider" id="weight-teacher" oninput="updateWeightValue('teacher')">
            </div>

            <div class="weight-slider-container">
                <div class="weight-label">
                    <span class="weight-name">
                        <input type="checkbox" class="weight-checkbox" id="check-math" checked>
                        <label for="check-math">Math Scores</label>
                    </span>
                    <span class="weight-value" id="weight-math-value">16.67%</span>
                </div>
                <input type="range" min="0" max="100" step="0.1" value="16.666666666666668" class="weight-slider" id="weight-math" oninput="updateWeightValue('math')">
            </div>

            <div class="weight-slider-container">
                <div class="weight-label">
                    <span class="weight-name">
                        <input type="checkbox" class="weight-checkbox" id="check-reading" checked>
                        <label for="check-reading">Reading Scores</label>
                    </span>
                    <span class="weight-value" id="weight-reading-value">16.67%</span>
                </div>
                <input type="range" min="0" max="100" step="0.1" value="16.666666666666668" class="weight-slider" id="weight-reading" oninput="updateWeightValue('reading')">
            </div>

            <div class="weight-slider-container">
                <div class="weight-label">
                    <span class="weight-name">
                        <input type="checkbox" class="weight-checkbox" id="check-safety" checked>
                        <label for="check-safety">Student Safety</label>
                    </span>
                    <span class="weight-value" id="weight-safety-value">16.67%</span>
                </div>
                <input type="range" min="0" max="100" step="0.1" value="16.666666666666668" class="weight-slider" id="weight-safety" oninput="updateWeightValue('safety')">
            </div>

            <div class="weight-slider-container">
                <div class="weight-label">
                    <span class="weight-name">
                        <input type="checkbox" class="weight-checkbox" id="check-bullying" checked>
                        <label for="check-bullying">Low Bullying (100 - Bullying %)</label>
                    </span>
                    <span class="weight-value" id="weight-bullying-value">16.67%</span>
                </div>
                <input type="range" min="0" max="100" step="0.1" value="16.666666666666668" class="weight-slider" id="weight-bullying" oninput="updateWeightValue('bullying')">
            </div>

            <div class="weight-total">
                Total: <span class="weight-total-value" id="weight-total">100.00%</span>
            </div>

            <div class="weight-buttons">
                <button class="weight-btn weight-btn-reset" onclick="resetWeights()">Reset to Equal</button>
                <button class="weight-btn weight-btn-save" onclick="saveWeights()">Save Weights</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = 'mom'; // Default user

        const schools = [
            {"id":0,"name":"Nest + M","rankings":{"mom":1,"dad":5,"rowan":1},"openHouse":"scheduled","distance":"45 min subway","category":"Staff Pick","specialSauce":"G&T; K-12 (have to be invited to apply based on 4th grade report card)","redFlags":"","startTime":"","studentTeacher":"","insideSchools":"Staff Pick","principalEffective":"95","teacherRecommend":"97","mathScore":"100","readingScore":"99","feelSafe":"94","bullyingConcern":"32","percentWhite":"36","codingClasses":"","offCampusLunch":""},
            {"id":1,"name":"Brooklyn School of Inquiry","rankings":{"mom":7,"dad":3,"rowan":1},"openHouse":"scheduled","distance":"20 min drive","category":"Staff Pick","specialSauce":"G&T; science lab and greenhouse, kids encouraged to share their ideas in Socratic seminar, offers accelerated math like algebra","redFlags":"","startTime":"","studentTeacher":"16:1","insideSchools":"Staff Pick","principalEffective":"88","teacherRecommend":"89","mathScore":"95","readingScore":"88","feelSafe":"89","bullyingConcern":"11","percentWhite":"44","codingClasses":"","offCampusLunch":""},
            {"id":2,"name":"NYC Lab Middle School (Dist2)","rankings":{"mom":8,"dad":8,"rowan":1},"openHouse":"scheduled","distance":"45 min subway","category":"Staff Pick","specialSauce":"take art 4x/wk, strong SEL, honors/advanced courses","redFlags":"","startTime":"","studentTeacher":"12:1","insideSchools":"Staff Pick","principalEffective":"89","teacherRecommend":"94","mathScore":"92","readingScore":"84","feelSafe":"85","bullyingConcern":"53","percentWhite":"28","codingClasses":"","offCampusLunch":"daily"},
            {"id":3,"name":"IS 239: Mark Twain","rankings":{"mom":1,"dad":5,"rowan":1},"openHouse":"online only","distance":"31 min drive","category":"Staff Pick","specialSauce":"G&T;  take the test","redFlags":"","startTime":"","studentTeacher":"","insideSchools":"Staff Pick","principalEffective":"88","teacherRecommend":"93","mathScore":"90","readingScore":"87","feelSafe":"82","bullyingConcern":"57","percentWhite":"39","codingClasses":"","offCampusLunch":""},
            {"id":4,"name":"New Voices","rankings":{"mom":1,"dad":2,"rowan":1},"openHouse":"available","distance":"25 W/ 16 B","category":"Staff Pick","specialSauce":"Strong arts focus, including graphic design.  Seemingly strong science program.  No language in 6 and 7,  French in 8th.  No gym.","redFlags":"No gym, no language in 6th and 7th","startTime":"","studentTeacher":"16:2","insideSchools":"Staff Pick","principalEffective":"100","teacherRecommend":"100","mathScore":"88","readingScore":"80","feelSafe":"85","bullyingConcern":"47","percentWhite":"45","codingClasses":"","offCampusLunch":""},
            {"id":5,"name":"Hellenic","rankings":{"mom":null,"dad":null,"rowan":null},"openHouse":"scheduled","distance":"","category":"Staff Pick","specialSauce":"","redFlags":"","startTime":"","studentTeacher":"","insideSchools":"Staff Pick","principalEffective":"90","teacherRecommend":"98","mathScore":"88","readingScore":"77","feelSafe":"96","bullyingConcern":"31","percentWhite":"44","codingClasses":"","offCampusLunch":""},
            {"id":6,"name":"M.S. 442: Carrol Gardens","rankings":{"mom":3,"dad":1,"rowan":1},"openHouse":"available","distance":"14 min walk","category":"Staff Pick","specialSauce":"two teachers per class; mastery based grading; Maker Lab, intensives tailored to their interests and level","redFlags":"","startTime":"8:00","studentTeacher":"","insideSchools":"Staff Pick","principalEffective":"96","teacherRecommend":"100","mathScore":"81","readingScore":"74","feelSafe":"90","bullyingConcern":"38","percentWhite":"43","codingClasses":"Yes, in technology class","offCampusLunch":"Yes 1 or 2 days/week"},
            {"id":7,"name":"MS 447 Math and Science Exploratory School","rankings":{"mom":2,"dad":10,"rowan":6},"openHouse":"scheduled","distance":"24 min subway","category":"Staff Pick","specialSauce":"lots of hands on learning, competency based evaluation","redFlags":"Oddly low reccomendation scores","startTime":"","studentTeacher":"","insideSchools":"Staff Pick","principalEffective":"72","teacherRecommend":"80","mathScore":"80","readingScore":"67","feelSafe":"76","bullyingConcern":"63","percentWhite":"42","codingClasses":"","offCampusLunch":""},
            {"id":8,"name":"BK prospect Clinton hill","rankings":{"mom":2,"dad":5,"rowan":null},"openHouse":"scheduled","distance":"1 min walk","category":"Noteworthy","specialSauce":"","redFlags":"","startTime":"","studentTeacher":"","insideSchools":"Noteworthy","principalEffective":"67","teacherRecommend":"98","mathScore":"77","readingScore":"76","feelSafe":"88","bullyingConcern":"57","percentWhite":"","codingClasses":"","offCampusLunch":""},
            {"id":9,"name":"BK Prospect Downtown","rankings":{"mom":null,"dad":9,"rowan":null},"openHouse":"","distance":"","category":"","specialSauce":"","redFlags":"","startTime":"","studentTeacher":"","insideSchools":"","principalEffective":"83","teacherRecommend":"92","mathScore":"80","readingScore":"77","feelSafe":"86","bullyingConcern":"58","percentWhite":"","codingClasses":"","offCampusLunch":""},
            {"id":10,"name":"MS 51 Wiliam Alexander","rankings":{"mom":4,"dad":6,"rowan":12},"openHouse":"scheduled","distance":"25 m bus or subway","category":"Staff Pick","specialSauce":"lots of activities, clubs, trips, homeroom 4x/day, \"many\" students get into top HSs.","redFlags":"","startTime":"","studentTeacher":"","insideSchools":"Staff Pick","principalEffective":"69","teacherRecommend":"74","mathScore":"72","readingScore":"61","feelSafe":"77","bullyingConcern":"65","percentWhite":"32","codingClasses":"","offCampusLunch":"daily"},
            {"id":11,"name":"BUGS","rankings":{"mom":6,"dad":3,"rowan":1},"openHouse":"scheduled","distance":"14 min walk","category":"Noteworthy","specialSauce":"ecology focus,; quiet time twice a day;  Technology/Graphic Design enrichment classes","redFlags":"","startTime":"8:00","studentTeacher":"28-30:1 but 2 teach in core","insideSchools":"Noteworthy","principalEffective":"47","teacherRecommend":"87","mathScore":"71","readingScore":"79","feelSafe":"84","bullyingConcern":"39","percentWhite":"52","codingClasses":"Tech/graphic design enrichment classes","offCampusLunch":"daily"},
            {"id":12,"name":"Lower Manhattan Community","rankings":{"mom":2,"dad":4,"rowan":1},"openHouse":"scheduled","distance":"29 min bus","category":"Staff Pick","specialSauce":"Low HW; art every day; trips with advisory group","redFlags":"","startTime":"","studentTeacher":"32:1","insideSchools":"Staff Pick","principalEffective":"97","teacherRecommend":"97","mathScore":"70","readingScore":"78","feelSafe":"90","bullyingConcern":"38","percentWhite":"31","codingClasses":"","offCampusLunch":"Daily"},
            {"id":13,"name":"Boerum Hill Int'l","rankings":{"mom":2,"dad":7,"rowan":1},"openHouse":"scheduled","distance":"22 min subway","category":"Noteworthy","specialSauce":"IB program; Low homework, 6-12, all kids take french or spanish","redFlags":"lg building shared w/three other MS programs, teachers and students say it is chaotic, not well managed, high teacher turnover","startTime":"","studentTeacher":"","insideSchools":"Noteworthy","principalEffective":"75","teacherRecommend":"85","mathScore":"69","readingScore":"64","feelSafe":"80","bullyingConcern":"54","percentWhite":"36","codingClasses":"","offCampusLunch":"Yes"},
            {"id":14,"name":"MS 88: Park Slope Ed Complex","rankings":{"mom":10,"dad":3,"rowan":1},"openHouse":"TBD","distance":"23 min walk","category":"Staff Pick","specialSauce":"accelerated courses; three sub schools (arts, medical, STEM)","redFlags":"","startTime":"","studentTeacher":"","insideSchools":"Staff Pick","principalEffective":"90","teacherRecommend":"96","mathScore":"62","readingScore":"59","feelSafe":"76","bullyingConcern":"66","percentWhite":"46","codingClasses":"yes in SMART house; and Medical","offCampusLunch":""},
            {"id":15,"name":"Brooklyn Collaborative Studies","rankings":{"mom":1,"dad":3,"rowan":1},"openHouse":"","distance":"27 min subway","category":"Staff Pick","specialSauce":"portfolio system, don't take regents (except bio), lots of teacher flexibility for class design,  6-12, outward bound","redFlags":"","startTime":"","studentTeacher":"","insideSchools":"Staff Pick","principalEffective":"91","teacherRecommend":"91","mathScore":"62","readingScore":"51","feelSafe":"91","bullyingConcern":"38","percentWhite":"23","codingClasses":"","offCampusLunch":""},
            {"id":16,"name":"MS 839","rankings":{"mom":5,"dad":2,"rowan":1},"openHouse":"scheduled","distance":"10 min walk","category":"Noteworthy","specialSauce":"wide variety of electives , \"crew\"-based","redFlags":"Accelerated courses like algebra ,biology. Lots of arts classes including computer digital art. Some say the academics aren't challenging","startTime":"8:45 AM","studentTeacher":"","insideSchools":"Noteworthy","principalEffective":"75","teacherRecommend":"94","mathScore":"62","readingScore":"60","feelSafe":"87","bullyingConcern":"54","percentWhite":"42","codingClasses":"x","offCampusLunch":""}
        ];

        const columns = [
            { key: 'rank', label: 'Rank', visible: true, sortable: true },
            { key: 'name', label: 'School Name', visible: true, sortable: false },
            { key: 'cumulativeScore', label: 'Cumulative Score', visible: true, sortable: true },
            { key: 'openHouse', label: 'Open House', visible: true, sortable: false },
            { key: 'distance', label: 'Distance', visible: true, sortable: false },
            { key: 'category', label: 'Category', visible: true, sortable: false },
            { key: 'insideSchools', label: 'Inside Schools', visible: true, sortable: false },
            { key: 'specialSauce', label: 'Special Sauce', visible: true, sortable: false },
            { key: 'redFlags', label: 'Red Flags', visible: true, sortable: false },
            { key: 'startTime', label: 'Start Time', visible: true, sortable: false },
            { key: 'studentTeacher', label: 'Student:Teacher', visible: true, sortable: false },
            { key: 'principalEffective', label: 'Principal Effective (%)', visible: true, sortable: true },
            { key: 'teacherRecommend', label: 'Teachers Recommend (%)', visible: true, sortable: true },
            { key: 'mathScore', label: 'Math Scores (%)', visible: true, sortable: true },
            { key: 'readingScore', label: 'Reading Scores (%)', visible: true, sortable: true },
            { key: 'feelSafe', label: 'Students Feel Safe (%)', visible: true, sortable: true },
            { key: 'bullyingConcern', label: 'Bullying Concern (%)', visible: true, sortable: true },
            { key: 'percentWhite', label: 'White (%)', visible: true, sortable: true },
            { key: 'codingClasses', label: 'Coding Classes', visible: true, sortable: false },
            { key: 'offCampusLunch', label: 'Off Campus Lunch', visible: true, sortable: false }
        ];

        // Sorting state
        let currentSort = {
            column: null,
            direction: null // 'asc' or 'desc'
        };

        // Category weights for cumulative score (default: equal weight)
        let categoryWeights = {
            principal: 100 / 6,
            teacher: 100 / 6,
            math: 100 / 6,
            reading: 100 / 6,
            safety: 100 / 6,
            bullying: 100 / 6
        };

        // Load saved data
        function loadData() {
            // Check data version and clear if old format
            const dataVersion = localStorage.getItem('dataVersion');
            if (dataVersion !== '2.0') {
                // Clear old data format
                localStorage.removeItem('schoolRankings');
                localStorage.removeItem('schoolData');
                localStorage.setItem('dataVersion', '2.0');
            }

            // Load current user
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = savedUser;
            }

            // Load rankings for all users
            const savedRankings = localStorage.getItem('schoolRankings');
            if (savedRankings) {
                try {
                    const rankings = JSON.parse(savedRankings);
                    schools.forEach((school) => {
                        if (rankings[school.id]) {
                            school.rankings = rankings[school.id];
                        }
                    });
                } catch (e) {
                    console.error('Error loading rankings:', e);
                    localStorage.removeItem('schoolRankings');
                }
            }

            const savedSchoolData = localStorage.getItem('schoolData');
            if (savedSchoolData) {
                try {
                    const data = JSON.parse(savedSchoolData);
                    schools.forEach((school) => {
                        if (data[school.id]) {
                            school.specialSauce = data[school.id].specialSauce || school.specialSauce;
                            school.redFlags = data[school.id].redFlags || school.redFlags;
                            school.startTime = data[school.id].startTime || school.startTime;
                            school.studentTeacher = data[school.id].studentTeacher || school.studentTeacher;
                        }
                    });
                } catch (e) {
                    console.error('Error loading school data:', e);
                    localStorage.removeItem('schoolData');
                }
            }

            const savedColumns = localStorage.getItem('columnVisibility');
            if (savedColumns) {
                try {
                    const visibility = JSON.parse(savedColumns);
                    columns.forEach((col) => {
                        if (visibility[col.key] !== undefined) {
                            col.visible = visibility[col.key];
                        }
                    });
                } catch (e) {
                    console.error('Error loading column visibility:', e);
                    localStorage.removeItem('columnVisibility');
                }
            }

            // Load category weights
            const savedWeights = localStorage.getItem('categoryWeights');
            if (savedWeights) {
                try {
                    categoryWeights = JSON.parse(savedWeights);
                } catch (e) {
                    console.error('Error loading category weights:', e);
                    localStorage.removeItem('categoryWeights');
                }
            }
        }

        // Save rankings for all users
        function saveRankings() {
            const rankings = {};
            schools.forEach(school => {
                rankings[school.id] = school.rankings;
            });
            localStorage.setItem('schoolRankings', JSON.stringify(rankings));
            localStorage.setItem('dataVersion', '2.0');
        }

        // Save current user
        function saveCurrentUser() {
            localStorage.setItem('currentUser', currentUser);
        }

        // Switch between users
        function switchUser(user) {
            currentUser = user;
            saveCurrentUser();

            // Clear sorting to show user's rankings
            currentSort.column = null;
            currentSort.direction = null;

            // Update tab active states
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById('tab-' + user).classList.add('active');

            // Re-render table with new user's rankings
            renderTable();
        }

        // Save school data (editable fields)
        function saveSchoolData() {
            const data = {};
            schools.forEach(school => {
                data[school.id] = {
                    specialSauce: school.specialSauce,
                    redFlags: school.redFlags,
                    startTime: school.startTime,
                    studentTeacher: school.studentTeacher
                };
            });
            localStorage.setItem('schoolData', JSON.stringify(data));
        }

        // Save column visibility
        function saveColumnVisibility() {
            const visibility = {};
            columns.forEach(col => {
                visibility[col.key] = col.visible;
            });
            localStorage.setItem('columnVisibility', JSON.stringify(visibility));
        }

        // Update school data when editing
        function updateSchoolField(schoolId, field, value) {
            const school = schools.find(s => s.id === schoolId);
            if (school) {
                school[field] = value;
                saveSchoolData();
            }
        }

        // Toggle controls panel
        function toggleControls() {
            const panel = document.getElementById('columnControls');
            panel.classList.toggle('active');
        }

        // Sort by column
        function sortByColumn(columnKey, direction) {
            if (!direction) {
                // Toggle direction if clicking the same column
                if (currentSort.column === columnKey) {
                    if (currentSort.direction === 'desc') {
                        direction = 'asc';
                    } else if (currentSort.direction === 'asc') {
                        // Clear sort
                        currentSort.column = null;
                        currentSort.direction = null;
                        renderTable();
                        return;
                    } else {
                        direction = 'desc';
                    }
                } else {
                    // Default to descending (high to low) for new column
                    direction = 'desc';
                }
            }

            currentSort.column = columnKey;
            currentSort.direction = direction;
            renderTable();
        }

        // Calculate average rank for a school
        function calculateAverageRank(school) {
            const ranks = [
                school.rankings.mom,
                school.rankings.dad,
                school.rankings.rowan
            ];
            const sum = ranks.reduce((a, b) => a + b, 0);
            return sum / ranks.length;
        }

        // Calculate cumulative score for a school
        function calculateCumulativeScore(school) {
            const principal = parseFloat(school.principalEffective) || 0;
            const teacher = parseFloat(school.teacherRecommend) || 0;
            const math = parseFloat(school.mathScore) || 0;
            const reading = parseFloat(school.readingScore) || 0;
            const safety = parseFloat(school.feelSafe) || 0;
            const bullying = parseFloat(school.bullyingConcern) || 0;
            const antibullying = bullying > 0 ? (100 - bullying) : 0;

            // Calculate weighted score
            const score = (
                (principal * categoryWeights.principal / 100) +
                (teacher * categoryWeights.teacher / 100) +
                (math * categoryWeights.math / 100) +
                (reading * categoryWeights.reading / 100) +
                (safety * categoryWeights.safety / 100) +
                (antibullying * categoryWeights.bullying / 100)
            );

            return score;
        }

        // Get min and max values for heatmap columns
        function getMinMaxForColumn(columnKey) {
            let values;

            if (columnKey === 'cumulativeScore') {
                values = schools
                    .map(s => calculateCumulativeScore(s))
                    .filter(v => !isNaN(v));
            } else {
                values = schools
                    .map(s => parseFloat(s[columnKey]))
                    .filter(v => !isNaN(v));
            }

            if (values.length === 0) return { min: 0, max: 100 };

            return {
                min: Math.min(...values),
                max: Math.max(...values)
            };
        }

        // Get background color for heatmap (yellow = best)
        function getHeatmapColor(value, columnKey) {
            if (!value || value === 'n/a') return '';
            
            const numValue = parseFloat(value);
            if (isNaN(numValue)) return '';
            
            const { min, max } = getMinMaxForColumn(columnKey);
            
            // For bullying concern, lower is better, so reverse the scale
            let normalizedValue;
            if (columnKey === 'bullyingConcern') {
                normalizedValue = max === min ? 0 : (max - numValue) / (max - min);
            } else {
                normalizedValue = max === min ? 0 : (numValue - min) / (max - min);
            }
            
            // Create a gradient from white (worst) to yellow (best)
            // Using HSL: yellow is hsl(60, 100%, 50%)
            // We'll go from white (hsl(60, 0%, 100%)) to yellow (hsl(60, 100%, 85%))
            const saturation = normalizedValue * 100;
            const lightness = 100 - (normalizedValue * 15); // 100% to 85%
            
            return `hsl(60, ${saturation}%, ${lightness}%)`;
        }

        // Show average rankings modal
        function showAverageRankings() {
            // Create a copy of schools array and sort by average rank
            const sortedSchools = [...schools].sort((a, b) => {
                return calculateAverageRank(a) - calculateAverageRank(b);
            });

            const list = document.getElementById('avgRankingList');
            list.innerHTML = '';

            sortedSchools.forEach((school, index) => {
                const avgRank = calculateAverageRank(school);
                const item = document.createElement('li');
                item.className = 'ranking-item';
                item.innerHTML = `
                    <div class="ranking-number">${index + 1}</div>
                    <div class="ranking-details">
                        <div class="ranking-school-name">${school.name}</div>
                        <div class="ranking-stats">
                            <span class="ranking-avg">Avg: ${avgRank.toFixed(2)}</span>
                            <span class="ranking-individual">(Mom: ${school.rankings.mom}, Dad: ${school.rankings.dad}, Rowan: ${school.rankings.rowan})</span>
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });

            document.getElementById('avgRankModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Close average rankings modal
        function closeAverageRankings() {
            document.getElementById('avgRankModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close modal when clicking on overlay (but not on content)
        function closeModalOnOverlay(event) {
            if (event.target.id === 'avgRankModal') {
                closeAverageRankings();
            } else if (event.target.id === 'weightsModal') {
                closeWeightsModal();
            }
        }

        // Show weights modal
        function showWeightsModal() {
            // Load current weights into sliders
            document.getElementById('weight-principal').value = categoryWeights.principal;
            document.getElementById('weight-teacher').value = categoryWeights.teacher;
            document.getElementById('weight-math').value = categoryWeights.math;
            document.getElementById('weight-reading').value = categoryWeights.reading;
            document.getElementById('weight-safety').value = categoryWeights.safety;
            document.getElementById('weight-bullying').value = categoryWeights.bullying;

            // Initialize previous values
            previousWeightValues.principal = categoryWeights.principal;
            previousWeightValues.teacher = categoryWeights.teacher;
            previousWeightValues.math = categoryWeights.math;
            previousWeightValues.reading = categoryWeights.reading;
            previousWeightValues.safety = categoryWeights.safety;
            previousWeightValues.bullying = categoryWeights.bullying;

            // Update displays (without triggering auto-adjust)
            document.getElementById('weight-principal-value').textContent = categoryWeights.principal.toFixed(2) + '%';
            document.getElementById('weight-teacher-value').textContent = categoryWeights.teacher.toFixed(2) + '%';
            document.getElementById('weight-math-value').textContent = categoryWeights.math.toFixed(2) + '%';
            document.getElementById('weight-reading-value').textContent = categoryWeights.reading.toFixed(2) + '%';
            document.getElementById('weight-safety-value').textContent = categoryWeights.safety.toFixed(2) + '%';
            document.getElementById('weight-bullying-value').textContent = categoryWeights.bullying.toFixed(2) + '%';

            updateWeightTotal();

            document.getElementById('weightsModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Close weights modal
        function closeWeightsModal() {
            document.getElementById('weightsModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Store previous values for change detection
        let previousWeightValues = {
            principal: 100 / 6,
            teacher: 100 / 6,
            math: 100 / 6,
            reading: 100 / 6,
            safety: 100 / 6,
            bullying: 100 / 6
        };

        // Update weight value display and auto-adjust other checked sliders
        function updateWeightValue(category) {
            const categories = ['principal', 'teacher', 'math', 'reading', 'safety', 'bullying'];
            const slider = document.getElementById('weight-' + category);
            const newValue = parseFloat(slider.value);
            const oldValue = previousWeightValues[category];
            const change = newValue - oldValue;

            // Update the display for this slider (rounded for display only)
            const display = document.getElementById('weight-' + category + '-value');
            display.textContent = newValue.toFixed(2) + '%';

            // Store new value with full precision
            previousWeightValues[category] = newValue;

            // Find all checked categories (excluding the current one)
            const checkedOthers = categories.filter(cat => {
                if (cat === category) return false; // Exclude the one being adjusted
                return document.getElementById('check-' + cat).checked;
            });

            // If there are other checked items, distribute the change among them
            if (checkedOthers.length > 0 && Math.abs(change) > 0.000001) {
                const adjustmentPerItem = -change / checkedOthers.length;

                checkedOthers.forEach(cat => {
                    const otherSlider = document.getElementById('weight-' + cat);
                    const otherDisplay = document.getElementById('weight-' + cat + '-value');
                    let otherValue = parseFloat(otherSlider.value) + adjustmentPerItem;

                    // Clamp between 0 and 100
                    otherValue = Math.max(0, Math.min(100, otherValue));

                    // Store with full precision
                    otherSlider.value = otherValue;
                    otherDisplay.textContent = otherValue.toFixed(2) + '%';
                    previousWeightValues[cat] = otherValue;
                });

                // Normalize to ensure total equals exactly 100%
                // This fixes floating point rounding errors
                const currentTotal = categories.reduce((sum, cat) => {
                    return sum + parseFloat(document.getElementById('weight-' + cat).value);
                }, 0);

                const difference = 100 - currentTotal;

                // If there's a rounding difference, add it to the first checked other item
                if (Math.abs(difference) > 0.000001 && checkedOthers.length > 0) {
                    const fixCat = checkedOthers[0];
                    const fixSlider = document.getElementById('weight-' + fixCat);
                    const fixDisplay = document.getElementById('weight-' + fixCat + '-value');
                    const fixedValue = parseFloat(fixSlider.value) + difference;

                    fixSlider.value = fixedValue;
                    fixDisplay.textContent = fixedValue.toFixed(2) + '%';
                    previousWeightValues[fixCat] = fixedValue;
                }
            }

            // Update total
            updateWeightTotal();
        }

        // Update total weight display
        function updateWeightTotal() {
            const total =
                parseFloat(document.getElementById('weight-principal').value) +
                parseFloat(document.getElementById('weight-teacher').value) +
                parseFloat(document.getElementById('weight-math').value) +
                parseFloat(document.getElementById('weight-reading').value) +
                parseFloat(document.getElementById('weight-safety').value) +
                parseFloat(document.getElementById('weight-bullying').value);

            const totalDisplay = document.getElementById('weight-total');
            totalDisplay.textContent = total.toFixed(2) + '%';

            // Color code based on validity (small tolerance for floating point precision)
            totalDisplay.className = 'weight-total-value';
            if (Math.abs(total - 100) < 0.01) {
                totalDisplay.classList.add('valid');
            } else {
                totalDisplay.classList.add('invalid');
            }
        }

        // Reset weights to equal
        function resetWeights() {
            const equalWeight = 100 / 6;
            document.getElementById('weight-principal').value = equalWeight;
            document.getElementById('weight-teacher').value = equalWeight;
            document.getElementById('weight-math').value = equalWeight;
            document.getElementById('weight-reading').value = equalWeight;
            document.getElementById('weight-safety').value = equalWeight;
            document.getElementById('weight-bullying').value = equalWeight;

            // Update previous values
            previousWeightValues.principal = equalWeight;
            previousWeightValues.teacher = equalWeight;
            previousWeightValues.math = equalWeight;
            previousWeightValues.reading = equalWeight;
            previousWeightValues.safety = equalWeight;
            previousWeightValues.bullying = equalWeight;

            // Update displays (without triggering auto-adjust)
            document.getElementById('weight-principal-value').textContent = equalWeight.toFixed(2) + '%';
            document.getElementById('weight-teacher-value').textContent = equalWeight.toFixed(2) + '%';
            document.getElementById('weight-math-value').textContent = equalWeight.toFixed(2) + '%';
            document.getElementById('weight-reading-value').textContent = equalWeight.toFixed(2) + '%';
            document.getElementById('weight-safety-value').textContent = equalWeight.toFixed(2) + '%';
            document.getElementById('weight-bullying-value').textContent = equalWeight.toFixed(2) + '%';

            updateWeightTotal();
        }

        // Save weights
        function saveWeights() {
            const total =
                parseFloat(document.getElementById('weight-principal').value) +
                parseFloat(document.getElementById('weight-teacher').value) +
                parseFloat(document.getElementById('weight-math').value) +
                parseFloat(document.getElementById('weight-reading').value) +
                parseFloat(document.getElementById('weight-safety').value) +
                parseFloat(document.getElementById('weight-bullying').value);

            // Check if total is 100 (with small tolerance for floating point)
            if (Math.abs(total - 100) > 0.01) {
                alert('Total weight must equal 100%. Current total: ' + total.toFixed(2) + '%');
                return;
            }

            // Save to categoryWeights object
            categoryWeights.principal = parseFloat(document.getElementById('weight-principal').value);
            categoryWeights.teacher = parseFloat(document.getElementById('weight-teacher').value);
            categoryWeights.math = parseFloat(document.getElementById('weight-math').value);
            categoryWeights.reading = parseFloat(document.getElementById('weight-reading').value);
            categoryWeights.safety = parseFloat(document.getElementById('weight-safety').value);
            categoryWeights.bullying = parseFloat(document.getElementById('weight-bullying').value);

            // Save to localStorage
            localStorage.setItem('categoryWeights', JSON.stringify(categoryWeights));

            // Close modal and re-render table
            closeWeightsModal();
            renderTable();
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAverageRankings();
                closeWeightsModal();
            }
        });

        // Drag and drop variables
        let draggedRow = null;
        let draggedSchoolId = null;

        // Handle drag start
        function handleDragStart(e, schoolId) {
            draggedRow = e.target.closest('tr');
            draggedSchoolId = schoolId;
            draggedRow.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', draggedRow.innerHTML);
        }

        // Handle drag over
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            
            const targetRow = e.target.closest('tr');
            if (targetRow && targetRow !== draggedRow) {
                // Remove previous drag-over classes
                document.querySelectorAll('.drag-over, .drag-over-bottom').forEach(row => {
                    row.classList.remove('drag-over', 'drag-over-bottom');
                });
                
                // Determine if we're dragging above or below
                const rect = targetRow.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;
                
                if (e.clientY < midpoint) {
                    targetRow.classList.add('drag-over');
                } else {
                    targetRow.classList.add('drag-over-bottom');
                }
            }
            
            return false;
        }

        // Handle drag enter
        function handleDragEnter(e) {
            const targetRow = e.target.closest('tr');
            if (targetRow && targetRow !== draggedRow) {
                targetRow.style.backgroundColor = '#f8f9fa';
            }
        }

        // Handle drag leave
        function handleDragLeave(e) {
            const targetRow = e.target.closest('tr');
            if (targetRow) {
                targetRow.style.backgroundColor = '';
                targetRow.classList.remove('drag-over', 'drag-over-bottom');
            }
        }

        // Handle drop
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            e.preventDefault();

            const targetRow = e.target.closest('tr');
            if (targetRow && targetRow !== draggedRow) {
                const targetSchoolId = parseInt(targetRow.dataset.schoolId);
                const draggedSchool = schools.find(s => s.id === draggedSchoolId);
                const targetSchool = schools.find(s => s.id === targetSchoolId);
                
                if (!draggedSchool || !targetSchool) return;
                
                // Determine if we're inserting above or below
                const rect = targetRow.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;
                const insertBefore = e.clientY < midpoint;
                
                // Calculate new rank for current user
                let newRank;
                if (insertBefore) {
                    newRank = targetSchool.rankings[currentUser];
                } else {
                    newRank = targetSchool.rankings[currentUser] + 1;
                }
                
                const oldRank = draggedSchool.rankings[currentUser];
                
                // Update all ranks for current user
                if (newRank < oldRank) {
                    // Moving up
                    schools.forEach(school => {
                        if (school.rankings[currentUser] >= newRank && school.rankings[currentUser] < oldRank) {
                            school.rankings[currentUser]++;
                        }
                    });
                } else if (newRank > oldRank) {
                    // Moving down
                    newRank--; // Adjust because we're moving past other items
                    schools.forEach(school => {
                        if (school.rankings[currentUser] > oldRank && school.rankings[currentUser] <= newRank) {
                            school.rankings[currentUser]--;
                        }
                    });
                }
                
                draggedSchool.rankings[currentUser] = newRank;
                
                saveRankings();
                renderTable();
            }

            return false;
        }

        // Handle drag end
        function handleDragEnd(e) {
            if (draggedRow) {
                draggedRow.classList.remove('dragging');
            }
            
            // Remove all drag-over classes
            document.querySelectorAll('.drag-over, .drag-over-bottom').forEach(row => {
                row.classList.remove('drag-over', 'drag-over-bottom');
                row.style.backgroundColor = '';
            });
            
            draggedRow = null;
            draggedSchoolId = null;
        }

        // Render column toggles
        function renderColumnToggles() {
            const container = document.getElementById('columnToggles');
            container.innerHTML = '';

            columns.forEach((col, index) => {
                if (col.key === 'rank' || col.key === 'name') return; // These are always visible

                const div = document.createElement('div');
                div.className = 'toggle-item';
                div.innerHTML = `
                    <input type="checkbox" 
                           id="col-${col.key}" 
                           ${col.visible ? 'checked' : ''}
                           onchange="toggleColumn('${col.key}')">
                    <label for="col-${col.key}">${col.label}</label>
                `;
                container.appendChild(div);
            });
        }

        // Toggle column visibility
        function toggleColumn(columnKey) {
            const column = columns.find(col => col.key === columnKey);
            if (column) {
                column.visible = !column.visible;
                saveColumnVisibility();
                renderTable();
            }
        }

        // Render table header
        function renderHeader() {
            const header = document.getElementById('tableHeader');
            header.innerHTML = '';

            const percentageColumns = ['principalEffective', 'teacherRecommend', 'mathScore', 'readingScore', 'feelSafe', 'bullyingConcern', 'percentWhite'];
            const centeredColumns = ['rank', 'cumulativeScore', ...percentageColumns];

            columns.forEach(col => {
                const th = document.createElement('th');

                if (!col.visible) {
                    th.className = 'hidden-col';
                }

                if (col.sortable) {
                    th.className = (th.className || '') + ' sortable';
                    th.innerHTML = `
                        ${col.label}
                        <span class="sort-arrows">
                            <span class="sort-arrow up ${currentSort.column === col.key && currentSort.direction === 'asc' ? 'active' : ''}">▲</span>
                            <span class="sort-arrow down ${currentSort.column === col.key && currentSort.direction === 'desc' ? 'active' : ''}">▼</span>
                        </span>
                    `;
                    th.onclick = () => sortByColumn(col.key);
                } else {
                    th.textContent = col.label;
                }

                if (centeredColumns.includes(col.key)) {
                    th.style.textAlign = 'center';
                }
                header.appendChild(th);
            });
        }

        // Render table
        function renderTable() {
            renderHeader();

            // Sort schools
            if (currentSort.column && currentSort.direction) {
                // Sort by the selected column
                schools.sort((a, b) => {
                    let aVal, bVal;

                    if (currentSort.column === 'cumulativeScore') {
                        aVal = calculateCumulativeScore(a);
                        bVal = calculateCumulativeScore(b);
                    } else if (currentSort.column === 'rank') {
                        aVal = a.rankings[currentUser] || 999;
                        bVal = b.rankings[currentUser] || 999;
                    } else {
                        aVal = parseFloat(a[currentSort.column]) || 0;
                        bVal = parseFloat(b[currentSort.column]) || 0;
                    }

                    if (currentSort.direction === 'asc') {
                        return aVal - bVal;
                    } else {
                        return bVal - aVal;
                    }
                });
            } else {
                // Sort by current user's rank
                schools.sort((a, b) => a.rankings[currentUser] - b.rankings[currentUser]);
            }

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            schools.forEach((school) => {
                const row = document.createElement('tr');
                row.draggable = true;
                row.dataset.schoolId = school.id;
                
                // Add drag event listeners
                row.addEventListener('dragstart', (e) => handleDragStart(e, school.id));
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('dragenter', handleDragEnter);
                row.addEventListener('dragleave', handleDragLeave);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragend', handleDragEnd);
                
                columns.forEach(col => {
                    const td = document.createElement('td');
                    if (!col.visible) {
                        td.className = 'hidden-col';
                    }

                    switch(col.key) {
                        case 'rank':
                            td.innerHTML = `
                                <div class="rank-cell">
                                    <div class="drag-handle" title="Drag to reorder">⋮⋮</div>
                                    <div class="rank-display">${school.rankings[currentUser]}</div>
                                </div>
                            `;
                            break;
                        case 'name':
                            td.className = (td.className || '') + ' school-name';
                            td.textContent = school[col.key];
                            break;
                        case 'category':
                        case 'insideSchools':
                            if (school[col.key]) {
                                td.innerHTML = `<span class="badge badge-${school[col.key] === 'Staff Pick' ? 'staff' : 'noteworthy'}">${school[col.key]}</span>`;
                            }
                            break;
                        case 'specialSauce':
                        case 'redFlags':
                            const wideDiv = document.createElement('div');
                            wideDiv.className = 'editable-cell wide';
                            wideDiv.contentEditable = true;
                            wideDiv.textContent = school[col.key] || '';
                            wideDiv.addEventListener('blur', function() {
                                updateSchoolField(school.id, col.key, this.textContent);
                            });
                            wideDiv.addEventListener('keydown', function(e) {
                                if (e.key === 'Enter' && !e.shiftKey) {
                                    e.preventDefault();
                                    this.blur();
                                }
                            });
                            // Prevent drag when editing
                            wideDiv.addEventListener('mousedown', function(e) {
                                e.stopPropagation();
                                row.draggable = false;
                            });
                            wideDiv.addEventListener('blur', function() {
                                row.draggable = true;
                                updateSchoolField(school.id, col.key, this.textContent);
                            });
                            td.appendChild(wideDiv);
                            break;
                        case 'startTime':
                        case 'studentTeacher':
                            const narrowDiv = document.createElement('div');
                            narrowDiv.className = 'editable-cell narrow';
                            narrowDiv.contentEditable = true;
                            narrowDiv.textContent = school[col.key] || '';
                            narrowDiv.addEventListener('blur', function() {
                                updateSchoolField(school.id, col.key, this.textContent);
                            });
                            narrowDiv.addEventListener('keydown', function(e) {
                                if (e.key === 'Enter') {
                                    e.preventDefault();
                                    this.blur();
                                }
                            });
                            // Prevent drag when editing
                            narrowDiv.addEventListener('mousedown', function(e) {
                                e.stopPropagation();
                                row.draggable = false;
                            });
                            narrowDiv.addEventListener('blur', function() {
                                row.draggable = true;
                                updateSchoolField(school.id, col.key, this.textContent);
                            });
                            td.appendChild(narrowDiv);
                            break;
                        case 'cumulativeScore':
                            const cumulativeScore = calculateCumulativeScore(school);
                            td.textContent = cumulativeScore.toFixed(0);
                            td.style.textAlign = 'center';
                            td.style.fontWeight = '700';
                            td.style.fontSize = '16px';
                            td.style.backgroundColor = getHeatmapColor(cumulativeScore, 'cumulativeScore');
                            break;
                        case 'principalEffective':
                        case 'teacherRecommend':
                        case 'mathScore':
                        case 'readingScore':
                        case 'feelSafe':
                        case 'bullyingConcern':
                            // Display percentage values with heatmap
                            td.textContent = school[col.key] ? school[col.key] + '%' : '';
                            td.style.textAlign = 'center';
                            td.style.backgroundColor = getHeatmapColor(school[col.key], col.key);
                            td.style.fontWeight = '600';
                            break;
                        case 'percentWhite':
                            // Display percentage without heatmap (it's demographic data, not a score)
                            td.textContent = school[col.key] ? school[col.key] + '%' : '';
                            td.style.textAlign = 'center';
                            break;
                        default:
                            td.textContent = school[col.key] || '';
                    }
                    
                    row.appendChild(td);
                });

                tbody.appendChild(row);
            });
        }

        // Initialize
        loadData();

        // Function to fix duplicate rankings for a specific user
        function fixDuplicateRankings(user) {
            // Get all schools with valid rankings for this user
            const schoolsWithRankings = schools.filter(s =>
                s.rankings && typeof s.rankings[user] === 'number'
            );

            // Check for duplicates
            const rankCounts = {};
            schoolsWithRankings.forEach(school => {
                const rank = school.rankings[user];
                rankCounts[rank] = (rankCounts[rank] || 0) + 1;
            });

            const hasDuplicates = Object.values(rankCounts).some(count => count > 1);

            if (hasDuplicates || schoolsWithRankings.length !== schools.length) {
                console.log(`Fixing rankings for ${user}...`);
                // Sort by current rank (preserving relative order where possible)
                const sorted = [...schools].sort((a, b) => {
                    const aRank = (a.rankings && a.rankings[user]) || 999;
                    const bRank = (b.rankings && b.rankings[user]) || 999;
                    return aRank - bRank;
                });

                // Assign sequential rankings
                sorted.forEach((school, index) => {
                    if (!school.rankings) {
                        school.rankings = { mom: null, dad: null, rowan: null };
                    }
                    school.rankings[user] = index + 1;
                });

                return true;
            }

            return false;
        }

        // Fix rankings for all users
        let needsSaving = false;
        needsSaving = fixDuplicateRankings('mom') || needsSaving;
        needsSaving = fixDuplicateRankings('dad') || needsSaving;
        needsSaving = fixDuplicateRankings('rowan') || needsSaving;

        if (needsSaving) {
            saveRankings();
        }
        
        renderColumnToggles();
        
        // Set active tab based on loaded user
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.getElementById('tab-' + currentUser).classList.add('active');
        
        renderTable();
    </script>
</body>
</html>
